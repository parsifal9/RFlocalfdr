---
title: "RFlocalfdr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RFlocalfdr}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(RFlocalfdr)
```
```{r variable counts}
library(ranger)
rf1<-ranger(Species ~ ., data = iris,importance="impurity",seed=123)
t2<-count_variables(rf1)
imp<-log(rf1$variable.importance)
plot(density((imp)))
hist(imp,col=6,lwd=2,breaks=100,main="histogram of importances")
```

```{r detemine a cutoff to get unimodal density}
# detemine a cutoff to get unimodal density

plot(density(log(imp)),lwd=3,ylim=c(0,0.2))
lines(density(log(imp[t2 == 1])),col=2,lwd=2)
lines(density(log(imp[t2 == 2])),col=3,lwd=2)
lines(density(log(imp[t2 == 3])),col=4,lwd=2)
lines(density(log(imp[t2 == 4])),col=5,lwd=2)
lines(density(log(imp[t2== 5])),col=6,lwd=2)
plot(density(log(imp[t2 > 3])),col=6,lwd=2)
hist(log(imp[t2 > 3]),col=6,lwd=2,breaks=200)

#################################################################################
# make cutoff
hist(imp[t2 > 3],col=6,lwd=2,breaks=10)
imp <- imp[t2 > 3]
#################################################################################


```{r scale data}
temp.data <- imp - min(imp) + .Machine$double.eps 
length(temp.data) #[1] 18317
```


#################################################################################
```{r  load some test data (iris is too small}
rm(list=ls())
data(imp1)
```
```{r  load some test data (iris is too small}
#################################################################################
#fit spline
f<- f.spline(imp1)


#################################################################################
########skew normal by nls
## this is just a test 
y<-f$zh$density
x<-f$x
plot(x,y,type="l")
df<-data.frame(x,y)

mm1.df = minpack.lm::nlsLM(y ~ my.dsn(x,xi=xi, omega=omega, lambda=lambda), 
                   start = list(xi=1, omega=2, lambda= 1 ),
                   data = df,control=minpack.lm::nls.lm.control(maxiter=400))

plot(df$x,df$y,type="l",col="green",lwd=2,xlim=c(0,2.5))
lines(x,predict(mm1.df),col="red",lwd=3)  
curve(sn::dsn(x,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], alpha= summary(mm1.df)$parameters[3,1] ),  add=TRUE,col="blue",lwd=3)
abline(v=sn::qsn(0.5,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], alpha= summary(mm1.df)$parameters[3,1] ))
abline(v=sn::qsn(0.05,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], alpha= summary(mm1.df)$parameters[3,1] ))
abline(v=sn::qsn(0.95,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], alpha= summary(mm1.df)$parameters[3,1] ))

sum(abs(df$y-predict(mm1.df))) #  4.631543


aa<-local.fdr(f,FUN=my.dsn,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], lambda= summary(mm1.df)$parameters[3,1] )
plot(x,aa)
abline(h=0.2)
ww<-which.min(abs(aa[20:119]-0.2))
sum(imp1> x[as.numeric(names(ww))])  # 351

##############################################################################################################
# determine the value p0, C
# this may not work as we are looking for a very small proportion of non-null genes
# set p0 to 1
# set C as below




##############################################################################################################
C<-sn::qsn(0.95,  xi=summary(mm1.df)$parameters[1,1], omega=summary(mm1.df)$parameters[2,1], alpha= summary(mm1.df)$parameters[3,1] )
hist(imp1,col=6,lwd=2,breaks=100,main="histogram of importances")
abline(v=C)
df2<-data.frame(x[x< C],y[x< C])
names(df2)<-c("x","y")

mm1.df2 = minpack.lm::nlsLM(y ~ my.dsn(x,xi=xi, omega=omega, lambda=lambda), 
                   start = list(xi=1, omega=2, lambda= 1 ),
                   data = df2,control=minpack.lm::nls.lm.control(maxiter=400))

#compare the plots 
plot(x,y,type="l",col="grey90",lwd=2,xlim=c(0,3))
lines(df2$x,df2$y,col="green",lwd=2)
lines(x,predict(mm1.df2,newdata=df),col="red",lwd=3)  
lines(x,predict(mm1.df,newdata=df),col="blue",lwd=3)  

aa<-local.fdr(f,FUN=my.dsn,  xi=summary(mm1.df2)$parameters[1,1], omega=summary(mm1.df2)$parameters[2,1], lambda= summary(mm1.df2)$parameters[3,1] )
plot(x,aa)
abline(h=0.2)
ww<-which.min(abs(aa[20:119]-0.2))
sum(imp1> x[as.numeric(names(ww))])  # 452
abline(v=x[as.numeric(names(ww))])

hist(imp1, breaks = 200,freq=FALSE)
abline(v=qsn(0.95,  xi=summary(mm1.df2)$parameters[1,1], omega=summary(mm1.df2)$parameters[2,1], alpha= summary(mm1.df2)$parameters[3,1] ))
abline(v=x[as.numeric(names(ww))])
abline(v=0.9041675,col="red")

```
